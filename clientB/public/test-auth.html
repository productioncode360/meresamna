<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Auth Portal | ClientB</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: white; display: flex; justify-content: center; padding: 50px; }
        .container { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 400px; border: 1px solid #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        h2 { text-align: center; margin-bottom: 20px; color: #fff; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 5px; border: 1px solid #444; background: #252525; color: white; box-sizing: border-box; outline: none; }
        input:focus { border-color: #007bff; }
        button { width: 100%; padding: 12px; background: #007bff; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 10px 0; transition: 0.3s; }
        button:hover { opacity: 0.9; }
        button.green { background: #28a745; }
        button.red { background: #dc3545; }
        button.google { background: #db4437; margin-top: 10px; }
        .msg { margin-top: 10px; font-size: 14px; text-align: center; color: #0f0; white-space: pre-line; min-height: 20px; }
        .msg.error { color: #f55; }
        .tabs { display: flex; justify-content: space-around; margin-bottom: 20px; cursor: pointer; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab { padding: 8px 12px; border-radius: 5px; font-size: 14px; color: #bbb; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .profile-card { background: #252525; padding: 15px; border-radius: 8px; font-size: 14px; margin-top: 10px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸš€ ClientB Auth Portal</h2>

    <div class="tabs">
        <div class="tab active" data-tab="register">Register</div>
        <div class="tab" data-tab="login">Login</div>
        <div class="tab" data-tab="forgot">Forgot</div>
        <div class="tab" data-tab="profile">Profile</div>
    </div>

    <div class="tab-content active" id="register">
        <input type="text" id="regName" placeholder="Full Name">
        <input type="email" id="regEmail" placeholder="Enter Email">
        <input type="password" id="regPassword" placeholder="Enter Password">
        <button id="regBtn" onclick="register()">Register & Send OTP</button>

        <div id="otpBox" style="display:none;">
            <hr style="border: 0.5px solid #333; margin: 15px 0;">
            <input type="text" id="otp" placeholder="Enter 6-Digit OTP">
            <button class="green" onclick="verifyOtp()">Verify OTP</button>
        </div>

        <button class="google" onclick="googleLogin()">Login with Google</button>
        <div id="regMsg" class="msg"></div>
    </div>

    <div class="tab-content" id="login">
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Login</button>
        <button class="google" onclick="googleLogin()">Login with Google</button>
        <div id="loginMsg" class="msg"></div>
    </div>

    <div class="tab-content" id="forgot">
        <input type="email" id="forgotEmail" placeholder="Enter Registered Email">
        <button class="green" onclick="sendForgotOtp()">Send OTP</button>
        <div id="forgotOtpBox" style="display:none;">
            <input type="text" id="forgotOtp" placeholder="Enter OTP">
            <input type="password" id="newPassword" placeholder="New Password">
            <button class="green" onclick="handleResetPassword()">Submit</button>
        </div>
        <div id="forgotMsg" class="msg"></div>
    </div>

    <div class="tab-content" id="profile">
        <div id="profileInfo" class="profile-card">Not logged in</div>
        <button class="red" onclick="handleLogout()">Logout</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBKf34DnjN3jc7XTyHbKwWdv2tqN_8ThuQ",
        authDomain: "backendauth-7ad2a.firebaseapp.com",
        projectId: "backendauth-7ad2a",
        storageBucket: "backendauth-7ad2a.firebasestorage.app",
        messagingSenderId: "107612920798",
        appId: "1:107612920798:web:19fa7988fa985e200e5b4f",
        measurementId: "G-40F7S4J9G2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // GOOGLE LOGIN (FIXED)
    window.googleLogin = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;

            // FIX: Backend verification ke liye idToken nikalna zaroori hai
            const idToken = await user.getIdToken();

            const res = await fetch(`http://localhost:5005/api/auth/google-login_ty58d`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: idToken }) // Sirf token bhejien, backend verify khud karega
            });

            const data = await res.json();
            if(res.ok) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('activeModule', 'ty58d');
                updateProfileUI(data.user);
                showMsg('loginMsg', 'âœ… Google Login Synced!');
                document.querySelector('[data-tab="profile"]').click();
            } else {
                showMsg('loginMsg', 'Backend Error: ' + data.message, true);
            }
        } catch (error) {
            showMsg('loginMsg', 'Google Error: ' + error.message, true);
        }
    };

    window.firebaseSignOut = () => signOut(auth);
</script>

<script>
const API = "http://localhost:5005/api/auth";

// Tab Switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
    });
});

function showMsg(id, text, error=false) {
    const el = document.getElementById(id);
    if(el) {
        el.innerText = text;
        el.className = error ? 'msg error' : 'msg';
    }
}

function updateProfileUI(user) {
    const profileEl = document.getElementById('profileInfo');
    if(user) {
        const mod = localStorage.getItem('activeModule');
        profileEl.innerHTML = `
            <strong>Name:</strong> ${user.name}<br>
            <strong>Email:</strong> ${user.email}<br>
            <strong>Module:</strong> ${mod} âœ…`;
    } else {
        profileEl.innerText = 'Not logged in';
    }
}

// NODEMAILER FLOW (_v34x)
async function register() {
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;
    const name = document.getElementById('regName').value;
    
    try {
        const res = await fetch(`${API}/register_v34x`, {
            method: 'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({email, password, name})
        });
        const data = await res.json();
        if(!res.ok) return showMsg('regMsg', data.message, true);
        
        showMsg('regMsg', 'Account created! Sending OTP...');
        sendOtpForVerification(email);
    } catch(err){ showMsg('regMsg', 'Server Offline', true); }
}

async function sendOtpForVerification(email) {
    try {
        const res = await fetch(`${API}/send-otp_v34x`, {
            method: 'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({email})
        });
        if(res.ok) {
            document.getElementById('otpBox').style.display = 'block';
            showMsg('regMsg','OTP sent to ' + email);
        }
    } catch(err){ showMsg('regMsg', 'OTP Failed', true); }
}

async function verifyOtp() {
    const email = document.getElementById('regEmail').value;
    const otp = document.getElementById('otp').value;
    try {
        const res = await fetch(`${API}/verify-otp_v34x`, {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email, otp})
        });
        const data = await res.json();
        if(res.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('activeModule', 'v34x');
            updateProfileUI(data.user);
            showMsg('regMsg','âœ… Account Verified!');
            setTimeout(() => document.querySelector('[data-tab="profile"]').click(), 1000);
        } else showMsg('regMsg', data.message, true);
    } catch(err){ showMsg('regMsg', 'Error', true); }
}

async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
        const res = await fetch(`${API}/login_v34x`, {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email, password})
        });
        const data = await res.json();
        if(res.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('activeModule', 'v34x');
            updateProfileUI(data.user);
            document.querySelector('[data-tab="profile"]').click();
        } else showMsg('loginMsg', data.message, true);
    } catch(err){ showMsg('loginMsg', 'Login Error', true); }
}

// LOGOUT
async function handleLogout() {
    const module = localStorage.getItem('activeModule') || 'v34x';
    try {
        await fetch(`${API}/logout_${module}`, { method: 'POST' });
        if(module === 'ty58d' && window.firebaseSignOut) await window.firebaseSignOut();
        
        localStorage.clear();
        location.reload();
    } catch(err) { location.reload(); }
}

// FORGOT PASSWORD
async function sendForgotOtp() {
    const email = document.getElementById('forgotEmail').value;
    try {
        const res = await fetch(`${API}/send-otp_v34x`, {
            method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email})
        });
        if(res.ok) {
            document.getElementById('forgotOtpBox').style.display = 'block';
            showMsg('forgotMsg','OTP sent!');
        }
    } catch(err) { showMsg('forgotMsg', 'Error', true); }
}

async function handleResetPassword() {
    const email = document.getElementById('forgotEmail').value;
    const otp = document.getElementById('forgotOtp').value;
    const newPassword = document.getElementById('newPassword').value;
    try {
        const res = await fetch(`${API}/reset-password_v34x`, {
            method:'POST', headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({ email, otp, newPassword })
        });
        if(res.ok) {
            showMsg('forgotMsg','âœ… Done! Please Login.');
            setTimeout(() => document.querySelector('[data-tab="login"]').click(), 2000);
        }
    } catch(err) { showMsg('forgotMsg', 'Reset Failed', true); }
}
</script>

</body>
</html>