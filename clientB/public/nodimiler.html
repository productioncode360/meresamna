<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Email Auth Portal | ClientB</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; display: flex; justify-content: center; padding: 50px; }
        .container { background: #1e1e1e; padding: 30px; border-radius: 15px; width: 400px; border: 1px solid #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        h2 { text-align: center; margin-bottom: 20px; color: #fff; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 5px; border: 1px solid #444; background: #252525; color: white; box-sizing: border-box; outline: none; }
        input:focus { border-color: #28a745; }
        button { width: 100%; padding: 12px; background: #28a745; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 10px 0; transition: 0.3s; }
        button:hover { opacity: 0.9; }
        button.blue { background: #007bff; }
        button.red { background: #dc3545; }
        .msg { margin-top: 10px; font-size: 14px; text-align: center; color: #0f0; white-space: pre-line; min-height: 20px; }
        .msg.error { color: #f55; }
        .tabs { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab { padding: 8px 12px; border-radius: 5px; font-size: 14px; color: #bbb; cursor: pointer; }
        .tab.active { background: #28a745; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .profile-card { background: #252525; padding: 15px; border-radius: 8px; font-size: 14px; margin-top: 10px; border-left: 4px solid #28a745; }
        hr { border: 0.5px solid #333; margin: 20px 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“§ Email Secure Portal</h2>

    <div class="tabs">
        <div class="tab active" data-tab="register">Register</div>
        <div class="tab" data-tab="login">Login</div>
        <div class="tab" data-tab="forgot">Forgot</div>
        <div class="tab" data-tab="profile">Profile</div>
    </div>

    <div class="tab-content active" id="register">
        <input type="text" id="regName" placeholder="Full Name">
        <input type="email" id="regEmail" placeholder="Email Address">
        <input type="password" id="regPassword" placeholder="Password">
        <button onclick="register()">Create Account</button>

        <div id="otpBox" style="display:none;">
            <hr>
            <input type="text" id="otp" placeholder="Enter 6-Digit OTP">
            <button class="blue" onclick="verifyOtp()">Verify & Finish</button>
        </div>
        <div id="regMsg" class="msg"></div>
    </div>

    <div class="tab-content" id="login">
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button class="blue" onclick="login()">Sign In</button>
        <div id="loginMsg" class="msg"></div>
    </div>

    <div class="tab-content" id="forgot">
        <input type="email" id="forgotEmail" placeholder="Registered Email">
        <button onclick="sendForgotOtp()">Get Reset OTP</button>
        <div id="forgotOtpBox" style="display:none;">
            <input type="text" id="forgotOtp" placeholder="OTP from Email">
            <input type="password" id="newPassword" placeholder="New Password">
            <button class="blue" onclick="handleResetPassword()">Update Password</button>
        </div>
        <div id="forgotMsg" class="msg"></div>
    </div>

    <div class="tab-content" id="profile">
        <div id="profileInfo" class="profile-card">Session Expired</div>
        <button class="red" onclick="handleLogout()">Logout</button>
    </div>
</div>

<script>
const API = "http://localhost:5005/api/auth";

// Tab Logic
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
    });
});

function showMsg(id, text, error=false) {
    const el = document.getElementById(id);
    if(el) {
        el.innerText = text;
        el.className = error ? 'msg error' : 'msg';
    }
}

function updateProfileUI(user) {
    const profileEl = document.getElementById('profileInfo');
    if(user) {
        profileEl.innerHTML = `
            <strong>User:</strong> ${user.name}<br>
            <strong>Email:</strong> ${user.email}<br>
            <strong>Security:</strong> OTP Verified âœ…`;
    }
}

// NODEMAILER FLOW
async function register() {
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;
    const name = document.getElementById('regName').value;
    
    try {
        const res = await fetch(`${API}/register_v34x`, {
            method: 'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({email, password, name})
        });
        const data = await res.json();
        if(!res.ok) return showMsg('regMsg', data.message, true);
        
        showMsg('regMsg', 'Account created! Check your email for OTP.');
        sendOtpForVerification(email);
    } catch(err){ showMsg('regMsg', 'Server Connection Error', true); }
}

async function sendOtpForVerification(email) {
    try {
        const res = await fetch(`${API}/send-otp_v34x`, {
            method: 'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({email})
        });
        if(res.ok) document.getElementById('otpBox').style.display = 'block';
    } catch(err){ showMsg('regMsg', 'Failed to send OTP', true); }
}

async function verifyOtp() {
    const email = document.getElementById('regEmail').value;
    const otp = document.getElementById('otp').value;
    try {
        const res = await fetch(`${API}/verify-otp_v34x`, {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email, otp})
        });
        const data = await res.json();
        if(res.ok) {
            localStorage.setItem('token', data.token);
            updateProfileUI(data.user);
            showMsg('regMsg','âœ… Success! Redirecting...');
            setTimeout(() => document.querySelector('[data-tab="profile"]').click(), 1500);
        } else showMsg('regMsg', data.message, true);
    } catch(err){ showMsg('regMsg', 'Verification Error', true); }
}

async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
        const res = await fetch(`${API}/login_v34x`, {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email, password})
        });
        const data = await res.json();
        if(res.ok) {
            localStorage.setItem('token', data.token);
            updateProfileUI(data.user);
            document.querySelector('[data-tab="profile"]').click();
        } else showMsg('loginMsg', data.message, true);
    } catch(err){ showMsg('loginMsg', 'Login Error', true); }
}

async function handleLogout() {
    await fetch(`${API}/logout_v34x`, { method: 'POST' });
    localStorage.clear();
    location.reload();
}

async function sendForgotOtp() {
    const email = document.getElementById('forgotEmail').value;
    try {
        const res = await fetch(`${API}/send-otp_v34x`, {
            method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email})
        });
        if(res.ok) {
            document.getElementById('forgotOtpBox').style.display = 'block';
            showMsg('forgotMsg','OTP sent to your inbox');
        }
    } catch(err) { showMsg('forgotMsg', 'Error sending OTP', true); }
}

async function handleResetPassword() {
    const email = document.getElementById('forgotEmail').value;
    const otp = document.getElementById('forgotOtp').value;
    const newPassword = document.getElementById('newPassword').value;
    try {
        const res = await fetch(`${API}/reset-password_v34x`, {
            method:'POST', headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({ email, otp, newPassword })
        });
        if(res.ok) {
            showMsg('forgotMsg','âœ… Password Updated!');
            setTimeout(() => document.querySelector('[data-tab="login"]').click(), 2000);
        }
    } catch(err) { showMsg('forgotMsg', 'Reset Failed', true); }
}
</script>

</body>
</html>